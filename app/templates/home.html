{% extends 'base.html' %}

{% block title %}
So s√°nh ti√™u ch√≠
{% endblock %}

{% block content %}
<div class="container-lg">
    <div class="py-3 px-4 shadow-lg rounded-4" style="background-color: rgb(250, 250, 250);">
        <div class="d-flex justify-content-between align-items-center">
            <div class=""><h5>Ch·ªçn lo·∫°i xe m√°y tr∆∞·ªõc khi ƒë√°nh gi√°</h5></div>
            <form method="POST" action="{{ url_for('main.home_page') }}">
                <select class="form-select bg-primary-subtle" id="hondaType" name="selected_honda_type_id" onchange="this.form.submit()">
                    <option value="">--- Ch·ªçn lo·∫°i xe ---</option>
                    {% for honda_type in honda_types %}
                    <option value="{{ honda_type.id }}" {% if selected_honda_type and selected_honda_type.id|string == honda_type.id|string %}selected{% endif %}>
                        {{ honda_type.name }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="fst-italic" style="font-size: 17px;">
            - Xe s·ªë: <br>
            + ∆Øu ƒëi·ªÉm: Ti·∫øt ki·ªám nhi√™n li·ªáu, ƒë·ªông c∆° m·∫°nh m·∫Ω, b·ªÅn b·ªâ, gi√° th√†nh th∆∞·ªùng th·∫•p h∆°n. <br>
            + Nh∆∞·ª£c ƒëi·ªÉm: C·∫ßn thao t√°c sang s·ªë, kh√¥ng ti·ªán l·ª£i khi d·ª´ng ƒë·ªó th∆∞·ªùng xuy√™n.
        </div>
        <div class="fst-italic mt-2" style="font-size: 17px;">
            - Xe tay ga: <br>
            + ∆Øu ƒëi·ªÉm: D·ªÖ l√°i, v·∫≠n h√†nh √™m √°i, c·ªëp ch·ª©a ƒë·ªì r·ªông, nhi·ªÅu ti·ªán √≠ch. <br>
            + Nh∆∞·ª£c ƒëi·ªÉm: Ti√™u hao nhi√™n li·ªáu h∆°n, gi√° th√†nh th∆∞·ªùng cao h∆°n, b·∫£o d∆∞·ª°ng ph·ª©c t·∫°p h∆°n.
        </div>
        <hr>
        <form method="POST" action="{{ url_for('main.home_page') }}" id="criteriaForm">
            <input type="hidden" name="selected_honda_type_id" id="selectedHondaTypeId" value="{{ selected_honda_type_id|default('') }}">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th></th>
                            {% for name in criteria_names %}
                            <th class="text-center align-middle">{{ name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(comparison_matrix|length) %}
                        <tr>
                            <th class="align-middle text-center">{{ criteria_names[i] }}</th>
                            {% for j in range(comparison_matrix|length) %}
                            <td class="text-center align-middle">
                                {% if i == j %}
                                <input type="text" class="form-control form-control-sm bg-primary-subtle"
                                       name="{{ comparison_matrix[i][j].id }}" id="input_{{ i }}_{{ j }}"
                                       value="{{ comparison_matrix[i][j].value }}" readonly disabled>
                                {% elif j < i %}
                                <input type="text" class="form-control form-control-sm"
                                       name="{{ comparison_matrix[i][j].id }}" id="input_{{ i }}_{{ j }}"
                                       value="{{ comparison_matrix[i][j].value }}" readonly disabled>
                                {% else %}
                                <input type="text" class="form-control form-control-sm upper-input {% if comparison_matrix[i][j].error %}is-invalid{% endif %}"
                                       name="{{ comparison_matrix[i][j].id }}" id="input_{{ i }}_{{ j }}"
                                       value="{{ comparison_matrix[i][j].value }}">
                                {% if comparison_matrix[i][j].error %}
                                    <div class="invalid-feedback">{{ comparison_matrix[i][j].error }}</div>
                                {% endif %}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-end gap-5">
                <button type="button" class="btn btn-secondary fw-bold rounded-pill shadow-lg px-2 py-2 w-100"
                        style="font-size: 18.5px;" id="resetMatrixToOne">Reset</button>
                <button type="submit" class="btn btn-primary fw-bold rounded-pill shadow-lg px-2 py-2 w-100 mt-lg-0 mt-2"
                        style="font-size: 18.5px;" id="calculateButton">T√≠nh k·∫øt qu·∫£</button>
            </div>
        </form>
        <hr>
        <div class="d-flex justify-content-between mt-2 gap-5">
            <div>
                {% if cr is not none %}
                {% if cr < 0.10 %}
                <div style="font-size: 18px;">
                    K·∫øt qu·∫£ tr·ªçng s·ªë v√† <span class="text-success">T·ª∑ s·ªë nh·∫•t qu√°n (CR): <strong>{{ (cr * 100)|round(2) }}%</strong>.</span>
                </div>
                {% else %}
                <div style="font-size: 18px;">
                    K·∫øt qu·∫£ tr·ªçng s·ªë v√† <span class="text-danger">T·ª∑ s·ªë nh·∫•t qu√°n (CR): <strong>{{ (cr * 100)|round(2) }}%</strong>.</span>
                </div>
                {% endif %}
                {% endif %}
                <div class="d-flex justify-content-center" style="width: 350px; height: 350px;">
                    <canvas id="criteriaPieChart"></canvas>
                </div>
            </div>
            <div>
                <div style="font-size: 18px;">X·∫øp h·∫°ng c√°c ph∆∞∆°ng √°n l·ª±a ch·ªçn theo lo·∫°i {% if selected_honda_type %} {{ selected_honda_type.name }} {% endif %}</div>
                <div id="alternativeMismatchWarning" class="text-danger" style="display: none;">
                    H√£y ki·ªÉm tra l·∫°i ƒë√°nh gi√° c√°c ma tr·∫≠n ph∆∞∆°ng √°n.
                </div>
                <div class="d-flex justify-content-center" style="width: 100%; height: 100%;">
                    <canvas id="alternativesBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    {% if weights is not none %}
    <div class="table-responsive d-none">
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th class="text-center bg-primary-subtle">Ti√™u ch√≠</th>
                    <th class="text-center bg-primary-subtle">Tr·ªçng s·ªë</th>
                </tr>
            </thead>
            <tbody>
                {% for i in range(weights|length) %}
                <tr>
                    <td><strong>{{ criteria_names[i] }}</strong></td>
                    <td class="text-end">
                        <span class="badge bg-primary rounded-pill" style="font-size: 18.5px;">
                            {{ (weights[i] * 100)|round(2) }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script type="text/javascript">
    // ƒê·ªãnh nghƒ©a c√°c bi·∫øn ch·ª©a d·ªØ li·ªáu t·ª´ Jinja2
    const appData = {
        allowedValues: {{ allowed_values|tojson|safe }},
        weights: {{ weights|default('null')|tojson|safe }},
        criteriaNames: {{ criteria_names|tojson|safe }},
        cr: {{ cr|default('0')|tojson|safe }}
    };

    document.addEventListener('DOMContentLoaded', function() {
        const upperInputs = document.querySelectorAll('.upper-input');
        const hondaTypeSelect = document.getElementById('hondaType');
        const selectedHondaTypeIdInput = document.getElementById('selectedHondaTypeId');
        const resetMatrixToOneButton = document.getElementById('resetMatrixToOne');
        const calculateButton = document.getElementById('calculateButton');
        const storedDataKey = 'ahpFormData';
        const alternativeMismatchWarning = document.getElementById('alternativeMismatchWarning');

        // L·∫•y d·ªØ li·ªáu ƒë√£ l∆∞u t·ª´ Local Storage
        const storedData = JSON.parse(localStorage.getItem(storedDataKey) || '{}');
        const comparisonValues = storedData.comparisonValues || {};
        const selectedHondaType = storedData.selectedHondaType;

        // H√†m ki·ªÉm tra gi√° tr·ªã input
        const isInputValueValid = (value) => {
            if (!value.trim()) {
                return true; // Cho ph√©p √¥ tr·ªëng
            }
            return appData.allowedValues.includes(value.trim());
        };

        // H√†m c·∫≠p nh·∫≠t √¥ ngh·ªãch ƒë·∫£o v√† ki·ªÉm tra gi√° tr·ªã
        const updateOppositeInput = (input) => {
            const value = input.value.trim();
            const [_, criteriaId1, criteriaId2] = input.name.split('_');
            const oppositeId = `comparison_${criteriaId2}_${criteriaId1}`;
            const oppositeInput = document.querySelector(`[name="${oppositeId}"]`);
            let isValid = true;

            input.classList.remove('is-invalid'); // Reset tr·∫°ng th√°i invalid

            if (oppositeInput) {
                oppositeInput.value = '';

                if (value) {
                    if (!isInputValueValid(value)) {
                        input.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        let calculatedValue;
                        if (value.includes('/')) {
                            const [numStr, denStr] = value.split('/');
                            const num = parseFloat(numStr);
                            const den = parseFloat(denStr);
                            if (!isNaN(num) && !isNaN(den) && den !== 0) {
                                calculatedValue = (den / num).toString();
                            } else {
                                isValid = false;
                                input.classList.add('is-invalid');
                            }
                        } else {
                            const numericValue = parseFloat(value);
                            if (!isNaN(numericValue) && numericValue > 0) {
                                calculatedValue = (1 / numericValue).toString();
                            } else {
                                isValid = false;
                                input.classList.add('is-invalid');
                            }
                        }
                        if (isValid) {
                            oppositeInput.value = calculatedValue;
                        }
                    }
                }
            }
            return isValid;
        };

        // Kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ Local Storage
        upperInputs.forEach(input => {
            if (comparisonValues[input.name]) {
                input.value = comparisonValues[input.name];
                updateOppositeInput(input);
            }
        });

        if (selectedHondaType) {
            hondaTypeSelect.value = selectedHondaType;
            selectedHondaTypeIdInput.value = selectedHondaType;
        }

        // L∆∞u gi√° tr·ªã ma tr·∫≠n v√†o Local Storage v√† c·∫≠p nh·∫≠t √¥ ngh·ªãch ƒë·∫£o khi input thay ƒë·ªïi
        upperInputs.forEach(input => {
            input.addEventListener('input', function() {
                if (updateOppositeInput(this)) {
                    storedData.comparisonValues = storedData.comparisonValues || {};
                    storedData.comparisonValues[this.name] = this.value.trim();
                    localStorage.setItem(storedDataKey, JSON.stringify(storedData));
                } else {
                    if (storedData.comparisonValues && storedData.comparisonValues[this.name]) {
                        delete storedData.comparisonValues[this.name];
                        localStorage.setItem(storedDataKey, JSON.stringify(storedData));
                    }
                }
            });
        });

        // L∆∞u gi√° tr·ªã lo·∫°i honda v√†o Local Storage v√† hidden input khi c√≥ thay ƒë·ªïi
        hondaTypeSelect.addEventListener('change', function() {
            storedData.selectedHondaType = this.value;
            localStorage.setItem(storedDataKey, JSON.stringify(storedData));
            selectedHondaTypeIdInput.value = this.value;
        });

        // X·ª≠ l√Ω s·ª± ki·ªán click c·ªßa n√∫t "ƒê·∫∑t l·∫°i v·ªÅ 1"
        resetMatrixToOneButton.addEventListener('click', function() {
            upperInputs.forEach(input => {
                if (!input.readOnly) {
                    input.value = '1';
                    input.classList.remove('is-invalid');
                    storedData.comparisonValues = storedData.comparisonValues || {};
                    storedData.comparisonValues[input.name] = '1';
                    const [_, criteriaId1, criteriaId2] = input.name.split('_');
                    const oppositeId = `comparison_${criteriaId2}_${criteriaId1}`;
                    const oppositeInput = document.querySelector(`[name="${oppositeId}"]`);
                    if (oppositeInput) {
                        oppositeInput.value = '1';
                    }
                }
            });
            localStorage.setItem(storedDataKey, JSON.stringify(storedData));
            appData.criteriaNames.forEach(criteriaName => {
                localStorage.removeItem(`${convertCriteriaName(criteriaName)}_alternative_weights`);
            });
            if (alternativeMismatchWarning) {
                alternativeMismatchWarning.style.display = 'none'; // ·∫®n c·∫£nh b√°o n·∫øu c√≥
            }
        });

        // X·ª≠ l√Ω s·ª± ki·ªán click c·ªßa n√∫t "T√≠nh to√°n tr·ªçng s·ªë"
        calculateButton.addEventListener('click', function(event) {
            if (!hondaTypeSelect.value) {
                event.preventDefault();
                alert('Vui l√≤ng ch·ªçn lo·∫°i honda tr∆∞·ªõc khi t√≠nh to√°n.');
                return;
            }

            const hasInvalidInput = Array.from(upperInputs).some(input => input.classList.contains('is-invalid'));
            if (hasInvalidInput) {
                event.preventDefault();
                alert('Vui l√≤ng nh·∫≠p gi√° tr·ªã h·ª£p l·ªá cho t·∫•t c·∫£ c√°c √¥ so s√°nh ti√™u ch√≠.');
            } else {
                // Sau khi t√≠nh to√°n tr·ªçng s·ªë ti√™u ch√≠ th√†nh c√¥ng, c√≥ th·ªÉ ·∫©n c·∫£nh b√°o (n·∫øu ƒëang hi·ªÉn th·ªã)
                if (alternativeMismatchWarning) {
                    alternativeMismatchWarning.style.display = 'none';
                }
            }
        });

        // H√†m t·∫°o bi·ªÉu ƒë·ªì tr√≤n
        const createPieChart = (canvasId, labels, data, labelText, backgroundColor) => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelText,
                        data: data,
                        backgroundColor: backgroundColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${context.raw.toFixed(2)}%`
                            }
                        }
                    }
                }
            });
        };

        // T·∫°o bi·ªÉu ƒë·ªì tr√≤n cho tr·ªçng s·ªë ti√™u ch√≠
        if (appData.weights !== null) {
            const backgroundColorsCriteria = [
                'rgba(255, 99, 132)',
                'rgba(54, 162, 235)',
                'rgba(255, 206, 86)',
                'rgba(75, 192, 192)',
                'rgba(153, 102, 255)',
                'rgba(255, 159, 64)',
                'rgba(199, 199, 199)'
            ];
            createPieChart('criteriaPieChart', appData.criteriaNames, appData.weights.map(w => w * 100), 'Tr·ªçng s·ªë ti√™u ch√≠ (%)', backgroundColorsCriteria);
        }

        const convertCriteriaName = (name) => {
            if(name === "ƒê·ªông c∆°") return "dongco";
            if(name === "Chi ph√≠") return "chiphi";
            if(name === "Thi·∫øt k·∫ø") return "thietke";
            if(name === "Ti·∫øt ki·ªám nhi√™n li·ªáu") return "tknl";
            if(name === "Ti·ªán √≠ch") return "tienich";
            return name;
        };

        // H√†m ƒë·ªÉ l·∫•y tr·ªçng s·ªë ph∆∞∆°ng √°n t·ª´ Local Storage v√† ki·ªÉm tra s·ª± ƒë·ªìng nh·∫•t
        const getAlternativeWeightsFromLocalStorage = () => {
            const alternativeWeights = {};
            let firstAlternatives = null;
            let mismatch = false;

            appData.criteriaNames.forEach(criteriaName => {
                const convertedName = convertCriteriaName(criteriaName);
                const weightsStr = localStorage.getItem(`${convertedName}_alternative_weights`);
                if (weightsStr) {
                    const weights = JSON.parse(weightsStr);
                    alternativeWeights[convertedName] = weights;
                    const currentAlternatives = Object.keys(weights).sort();

                    if (firstAlternatives === null) {
                        firstAlternatives = currentAlternatives;
                    } else if (currentAlternatives.length !== firstAlternatives.length || !currentAlternatives.every((value, index) => value === firstAlternatives[index])) {
                        mismatch = true;
                    }
                    console.log(`üöÄ ~ check (${convertedName}): `, weights);
                } else {
                    mismatch = true; // N·∫øu m·ªôt ti√™u ch√≠ kh√¥ng c√≥ d·ªØ li·ªáu ƒë√°nh gi√° ph∆∞∆°ng √°n
                }
            });

            if (mismatch && alternativeMismatchWarning) {
                alternativeMismatchWarning.style.display = 'block';
                return {}; // Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng r·ªóng ƒë·ªÉ ngƒÉn t√≠nh to√°n x·∫øp h·∫°ng
            } else if (alternativeMismatchWarning) {
                alternativeMismatchWarning.style.display = 'none';
            }

            return alternativeWeights;
        };

        // H√†m t√≠nh to√°n ƒëi·ªÉm s·ªë cu·ªëi c√πng cho c√°c ph∆∞∆°ng √°n
        const calculateFinalScores = (criteriaWeights, alternativeWeights) => {
            const finalScores = {};
            const firstCriteriaWeights = alternativeWeights[convertCriteriaName(appData.criteriaNames[0])];
            if (firstCriteriaWeights && Object.keys(alternativeWeights).length === appData.criteriaNames.length) {
                const alternatives = Object.keys(firstCriteriaWeights);
                alternatives.forEach(alternative => {
                    let score = 0;
                    for (let i = 0; i < appData.criteriaNames.length; i++) {
                        const criteriaName = appData.criteriaNames[i];
                        const convertedCriteriaName = convertCriteriaName(criteriaName);
                        const criteriaWeight = criteriaWeights[i];
                        const weightForAlternative = alternativeWeights[convertedCriteriaName]?.[alternative] || 0;
                        score += criteriaWeight * weightForAlternative;
                    }
                    finalScores[alternative] = score;
                });
            }
            return finalScores;
        };

        // H√†m s·∫Øp x·∫øp c√°c ph∆∞∆°ng √°n theo ƒëi·ªÉm s·ªë
        const rankAlternatives = (finalScores) => {
            return Object.entries(finalScores)
                .sort(([, scoreA], [, scoreB]) => scoreB - scoreA)
                .map(([alternative, score]) => ({ alternative, score }));
        };

        // H√†m t·∫°o bi·ªÉu ƒë·ªì c·ªôt ngang cho x·∫øp h·∫°ng ph∆∞∆°ng √°n v·ªõi nhi·ªÅu m√†u
        const createAlternativesBarChart = (rankedAlternatives) => {
            const labels = rankedAlternatives.map(item => item.alternative);
            const data = rankedAlternatives.map(item => item.score * 100); // Nh√¢n v·ªõi 100 ƒë·ªÉ hi·ªÉn th·ªã ph·∫ßn trƒÉm
            const backgroundColors = [
                '#CFE2FF', // Light Blue
            ];

            const ctx = document.getElementById('alternativesBarChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ƒêi·ªÉm s·ªë t·ªïng th·ªÉ (%)',
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length), // L·∫•y s·ªë l∆∞·ª£ng m√†u t∆∞∆°ng ·ª©ng
                        borderColor: backgroundColors.slice(0, labels.length).map(color => color.replace('0.7', '1')), // M√†u vi·ªÅn ƒë·∫≠m h∆°n
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'ƒêi·ªÉm s·ªë t·ªïng th·ªÉ (%)' }
                        },
                        y: {
                            title: { display: true, text: 'Ph∆∞∆°ng √°n' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${context.raw.toFixed(2)}%`
                            }
                        }
                    }
                }
            });
        };

        // T√≠nh to√°n v√† hi·ªÉn th·ªã x·∫øp h·∫°ng ph∆∞∆°ng √°n n·∫øu c√≥ tr·ªçng s·ªë ti√™u ch√≠ v√† CR h·ª£p l·ªá
        if (appData.weights !== null && parseFloat(appData.cr) < 0.10) {
                const alternativeWeights = getAlternativeWeightsFromLocalStorage();
                let rankedAlternatives = []; // Kh·ªüi t·∫°o bi·∫øn ngo√†i scope if

                if (Object.keys(alternativeWeights).length === appData.criteriaNames.length && Object.keys(alternativeWeights).every(key => Object.keys(alternativeWeights[key]).length > 0)) {
                    const finalScores = calculateFinalScores(appData.weights, alternativeWeights);
                    rankedAlternatives = rankAlternatives(finalScores);
                    createAlternativesBarChart(rankedAlternatives);
                }

                // L∆∞u ranked_alternatives v√†o session ƒë·ªÉ xu·∫•t PDF (lu√¥n g·ªçi khi c√≥ tr·ªçng s·ªë v√† CR h·ª£p l·ªá)
                fetch('/update_session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ranked_alternatives: rankedAlternatives })
                });
        }
    });
</script>

<style>
    .is-invalid {
        border-color: red;
    }
</style>

{% endblock %}